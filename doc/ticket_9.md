### 分布式和微服务相关

### 服务拆分

**拆分原则：**按照业务边界（领域驱动设计 DDD）拆分

**业务模块：**gateway网关模块，common公共模块，member用户模块，business购票业务模块。

**拆分带来的好处：**

- **可扩展性**：不同模块可以独立扩容，比如购票业务流量大时，只扩容 business 服务即可。
- **高内聚低耦合**：服务之间通过 API（OpenFeign）调用，避免了大而全的单体系统。
- **独立部署和升级**：某个服务修改后只需重新部署该服务，不影响其他服务。
- **容错性**：一个服务挂掉不会影响整个系统（比如短信服务挂了，购票流程还能走下去）。

**服务拆分的不足/挑战**

- **分布式复杂性**：要考虑分布式事务（Seata）、服务注册发现（Nacos）、配置中心、链路追踪。
- **部署和运维成本增加**：多个服务需要更复杂的 CI/CD 和监控体系。
- **跨服务调用性能开销**：调用链变长，需要缓存、异步化、消息队列来优化。

### 分布式事务

系统采用 Seata 来解决跨服务、跨库的分布式事务问题。在购票流程中，涉及余票扣减、订单状态更新、会员车票生成等操作，均通过 `@GlobalTransactional` 进行全局事务管理。这样保证了任意一步失败时，其余操作都会回滚，确保最终一致性。

**为什么需要分布式事务**

- 系统是 **微服务架构**，订单确认场景就涉及：
  - business 服务扣减余票
  - member 服务增加会员车票
  - order 服务更新订单状态
- 这些操作分布在不同的数据库、不同的服务里，必须保证 **一致性**（不能出现扣了票但没生成订单的情况）。

**选型：Seata**

- Seata 是 **Spring Cloud Alibaba 官方推荐** 的分布式事务框架。
- 用的是 **AT 模式**（自动代理数据源，二阶段提交），用 `@GlobalTransactional` 管理整个购票流程。
- 事务提交时：所有分支服务都成功 → 全局提交。
- 事务异常时：自动回滚，保证数据一致。

**这样写的好处**

- 避免了人工编写复杂的回滚逻辑。
- 保证了跨库、跨服务的一致性。

**需要补充的不足/挑战**

- 依赖 undo log，表设计和 SQL 复杂度会影响性能。
- 一般最佳实践：**核心扣减用数据库本地事务 + 补偿机制（MQ + 状态校正）**，而不是全靠全局事务。

### API幂等性设计

在购票下单接口中引入 令牌机制，每个请求都必须携带唯一 token，防止用户或网络重试造成的重复提交。

在订单消息处理环节，结合 RocketMQ 消息 ID 与redis数据库唯一约束，确保重复消息不会被多次消费/发送。

在数据库层面，通过乐观锁防止重复数据写入。