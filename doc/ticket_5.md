### 各版本说明

----

#### V1-train

- 完整的业务功能：登录/注册，乘客管理，**余票查询**，**车票购买**，我的车票，车次维护，每日车次维护，会员管理，车票管理
- 防止刷票功能，JWT 登录，网关和服务层拦截器，AOP方法级日志，异常处理，模块划分设计，各组件/框架/中间件集成。
- 秒杀/高并发场景初步处理：
  - **令牌桶削峰**控制请求压力。(非经典令牌桶，v3才是经典令牌桶)
  - **Redis 分布式锁**防止并发修改同一条余票数据。
  - **消息队列（MQ）异步处理订单**，削峰和解耦前端请求与后端库存操作。
- 数据一致性保证：
  - 基于 **数据库事务**和 Seata 全局事务控制订单、座位售票和库存修改。
  - **座位售票状态二进制表示**，避免重复售票。
  - **数据库唯一索引**限制同车次同区间重复插入。

**基本一致性和不超卖**

- 库存在数据库层做判断与扣减，保证基本不超卖（单点更新+事务）。
- 座位售票状态二进制处理，保证同一区间不会重复售票。
- 消息异步化保证高并发下订单请求不会直接阻塞数据库。

----

#### V1的不足

**库存和订单一致性**

- **没有 Redis 预扣减库存**，仍然依赖数据库实时扣减，无法充分削峰。
- **数据库没有行级/乐观锁机制**，可能在高并发下出现超卖或死锁问题。
- **Redis/Redisson 粗粒度锁**，锁粒度大，性能瓶颈明显。
- **Seata 全局事务**在秒杀高并发场景可能拖慢性能，增加系统耦合。
- **缺少异常回退/补偿机制**，一旦部分操作失败，可能导致库存与订单不一致。

**消息与异步处理**

- MQ 消息发送未使用事务消息，本地数据库修改与 MQ 消息可能不一致。
- 消费端处理是分页拉取 + 并行处理，无法保证严格顺序，可能造成库存错乱。
- **缺少死信队列和重试机制**，消费失败时可能丢失消息。

**系统设计与优化**

- 依赖数据库事务和回滚实现一致性，未充分利用缓存削峰。
- 秒杀场景下，性能未优化到极限。
- 缺少库存预扣减、幂等性设计和高并发优化措施。

---

#### V2-train-mp

MyBatis-Plus 重构：

- 替换原有生成器 + MyBatis 插件生成的 CRUD，减少重复代码。
- 使用 Lambda 查询构造器、条件构造器、分页等特性，提高开发效率与代码可维护性。
- 更利于整合库存预扣减、行级锁、幂等性控制等业务逻辑。

---

#### V3-train-opt

最佳实践，性能优化，高并发下不超买和一致性

- 增加 **Redis 预扣减库存**，在入库前先在缓存中判断和扣减库存，并使用Lua脚本原子化扣减/回滚库存。
- 数据库层增加 **乐观锁**，配合redis回滚和Seata事务确保并发扣减正确。
- 修改**令牌桶**，由SQL一次性添加令牌改为Redis经典限流令牌桶。
- MQ**幂等处理**避免重复发送或消费消息。

- **MQ异步**为会员添加乘客车票，进一步削峰和解耦。
- 优化 **Redis 锁粒度**（按车次 + 日期 + 座位类型，而不是整车）。
- 添加MQ发送确认机制和自动ACK，配合框架消息持久化、自动ACK、消费端重试机制和死信队列**保证消息不丢失**。
- Redis**缓存穿透、击穿、雪崩**的防护，使用缓存空值 + 布隆过滤器防穿透，使用互斥锁防击穿，过期时间随机化防雪崩。





