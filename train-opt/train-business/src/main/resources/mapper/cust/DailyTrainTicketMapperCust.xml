<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.nu11cat.train.business.mapper.cust.DailyTrainTicketMapperCust">

        <!--    未添加乐观锁-->
  <update id="updateCountBySell">
    update daily_train_ticket set
    <if test="seatTypeCode == '1'.toString()">
      ydz = ydz - 1
    </if>
    <if test="seatTypeCode == '2'.toString()">
      edz = edz - 1
    </if>
    <if test="seatTypeCode == '3'.toString()">
      rw = rw - 1
    </if>
    <if test="seatTypeCode == '4'.toString()">
      yw = yw - 1
    </if>
    where `date` = #{date}
    and train_code = #{trainCode}
    and start_index &gt;= #{minStartIndex}
    and start_index &lt;= #{maxStartIndex}
    and end_index &gt;= #{minEndIndex}
    and end_index &lt;= #{maxEndIndex}
  </update>

            <!--    添加乐观锁-->
    <update id="updateCountBySellOptimistic">
        update daily_train_ticket set
        <if test="seatTypeCode == 1">
            ydz = ydz - 1,
        </if>
        <if test="seatTypeCode == 2">
            edz = edz - 1,
        </if>
        <if test="seatTypeCode == 3">
            rw = rw - 1,
        </if>
        <if test="seatTypeCode == 4">
            yw = yw - 1,
        </if>
        version = version + 1
        where `date` = #{date}
        and train_code = #{trainCode}
        and start_index &gt;= #{minStartIndex}
        and start_index &lt;= #{maxStartIndex}
        and end_index &gt;= #{minEndIndex}
        and end_index &lt;= #{maxEndIndex}
        and version = #{version}
    </update>

    <!-- 根据日期、车次、起点、终点查询唯一余票记录 -->
    <select id="selectByUnique" resultType="cn.nu11cat.train.business.entity.DailyTrainTicket">
        SELECT
            id,
            date,
            train_code,
            start,
            start_pinyin,
            start_time,
            start_index,
            end,
            end_pinyin,
            end_time,
            end_index,
            ydz,
            ydz_price,
            edz,
            edz_price,
            rw,
            rw_price,
            yw,
            yw_price,
            create_time,
            update_time,
            version
        FROM daily_train_ticket
        WHERE date = #{date}
          AND train_code = #{trainCode}
          AND start = #{start}
          AND end = #{end}
        LIMIT 1
    </select>

</mapper>
